{% extends 'admin/layout.html' %}
{% block page_header_title %}<h1>Kategoriler</h1>{% endblock %}
{% block page_header_subtitle %}<p class="text-muted">Kategori yönetimi ve düzenleme</p>{% endblock %}
{% block page_header_actions %}
  <button class="btn btn-primary" onclick="openCreateModal()">
    <i class="fas fa-plus me-1"></i> 
    Yeni Kategori
  </button>
{% endblock %}

{% block content %}
<div class="page-container">
  <!-- Categories Table -->
  <div class="page-content-section">
    <div class="standard-card-header">
      <h5>
        <i class="fas fa-tags icon"></i>
        Kategoriler
        <span class="standard-stats-badge">{{ categories|length }} kategori</span>
      </h5>
    </div>
    <div class="standard-table-container">
      <div class="table-responsive">
        <table class="table standard-table">
            <thead>
              <tr>
                <th>Kategori</th>
                <th>Slug</th>
                <th>Açıklama</th>
                <th>Oluşturma</th>
                <th style="width: 150px;">İşlemler</th>
              </tr>
            </thead>
            <tbody>
              {% for category in categories %}
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="category-icon me-3">
                      <i class="fas fa-tag text-primary"></i>
                    </div>
                    <div>
                      <div class="fw-medium">{{ category.name }}</div>
                      <div class="text-muted small">ID: {{ category.category_id }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <code class="text-muted">{{ category.slug }}</code>
                </td>
                <td>
                  <span class="text-muted">
                    {{ category.description or 'Açıklama yok' }}
                  </span>
                </td>
                <td>
                  <span class="text-muted small">
                    {{ category.created_at }}
                  </span>
                </td>
                <td>
                  <div class="standard-btn-group">
                    <button class="btn btn-outline-primary" 
                            onclick="openEditModal({{ category.category_id }}, '{{ category.name }}', '{{ category.slug }}', '{{ category.description or '' }}')"
                            title="Düzenle">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" 
                            onclick="deleteCategory({{ category.category_id }}, '{{ category.name }}')"
                            title="Sil">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% if not categories %}
              <tr>
                <td colspan="5" class="standard-empty-state">
                  <i class="fas fa-tags icon"></i>
                  <h6>Henüz kategori bulunmuyor</h6>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Yeni Kategori</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="categoryForm">
          <input type="hidden" id="categoryId" name="category_id">
          <div class="mb-3">
            <label class="form-label">Kategori Adı <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="categoryName" name="name" required 
                   placeholder="Örn: Metin Üretimi">
            <div class="form-text">Kategorinin görünen adı</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Slug</label>
            <input type="text" class="form-control" id="categorySlug" name="slug" 
                   placeholder="Örn: metin-uretimi">
            <div class="form-text">URL'de kullanılacak kısa ad (otomatik oluşturulur)</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Açıklama</label>
            <textarea class="form-control" id="categoryDescription" name="description" rows="3" 
                      placeholder="Kategori hakkında açıklama..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" onclick="saveCategory()">
          <i class="fas fa-save me-1"></i>
          Kaydet
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let categoryModal;
let isEditMode = false;

// Initialize modal
document.addEventListener('DOMContentLoaded', function() {
  categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
  
  // Auto-generate slug from name
  document.getElementById('categoryName').addEventListener('input', function() {
    if (!isEditMode) {
      const name = this.value;
      const slug = name.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim('-');
      document.getElementById('categorySlug').value = slug;
    }
  });
});

async function api(path, method = 'GET', body) {
  const res = await fetch(path, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : undefined
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || 'İstek başarısız');
  return data;
}

function openCreateModal() {
  isEditMode = false;
  document.getElementById('modalTitle').textContent = 'Yeni Kategori';
  document.getElementById('categoryForm').reset();
  document.getElementById('categoryId').value = '';
  categoryModal.show();
}

function openEditModal(id, name, slug, description) {
  isEditMode = true;
  document.getElementById('modalTitle').textContent = 'Kategori Düzenle';
  document.getElementById('categoryId').value = id;
  document.getElementById('categoryName').value = name;
  document.getElementById('categorySlug').value = slug;
  document.getElementById('categoryDescription').value = description;
  categoryModal.show();
}

async function saveCategory() {
  const form = document.getElementById('categoryForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  
  // Validation
  if (!data.name.trim()) {
    AdminUI.showToast('Kategori adı zorunludur', 'error');
    return;
  }
  
  try {
    const categoryId = data.category_id;
    delete data.category_id;
    
    let result;
    if (categoryId) {
      // Update
      result = await api(`/admin/api/categories/${categoryId}`, 'PUT', data);
    } else {
      // Create
      result = await api('/admin/api/categories', 'POST', data);
    }
    
    if (result.success) {
      AdminUI.showToast(result.message || 'Kategori başarıyla kaydedildi', 'success');
      categoryModal.hide();
      location.reload();
    } else {
      AdminUI.showToast(result.error || 'Kategori kaydedilemedi', 'error');
    }
  } catch (error) {
    AdminUI.showToast(error.message || 'Bir hata oluştu', 'error');
  }
}

async function deleteCategory(id, name) {
  const confirmed = await AdminUI.confirmAction(
    `"${name}" kategorisini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz ve kategoriye bağlı tüm model ilişkileri de silinecektir.`
  );
  
  if (!confirmed) return;
  
  try {
    const result = await api(`/admin/api/categories/${id}`, 'DELETE');
    if (result.success) {
      AdminUI.showToast(result.message || 'Kategori başarıyla silindi', 'success');
      location.reload();
    } else {
      AdminUI.showToast(result.error || 'Kategori silinemedi', 'error');
    }
  } catch (error) {
    AdminUI.showToast(error.message || 'Bir hata oluştu', 'error');
  }
}
</script>

<style>
.category-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--gray-100);
  border-radius: var(--border-radius);
  font-size: 14px;
}

code {
  background: var(--gray-100);
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.875rem;
}

.fw-medium {
  font-weight: 500;
}

.btn-group-sm .btn {
  padding: 0.375rem 0.5rem;
  font-size: 0.75rem;
}

.text-danger {
  color: var(--danger) !important;
}

.form-text {
  font-size: 0.75rem;
  color: var(--gray-500);
  margin-top: 0.25rem;
}
</style>
{% endblock %}
