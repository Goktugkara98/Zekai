<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat.js AI Model Yönetimi Fonksiyon Raporu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fff1f2; /* Rose 50 arka plan */
        }
        .function-section {
            background-color: #ffffff;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem; /* 32px */
            padding: 1.5rem; /* 24px */
            border-left: 4px solid #f43f5e; /* Rose 500 kenarlık */
        }
        .function-title-text {
            color: #be123c; /* Rose 700 */
            font-weight: 600; /* Yarı kalın */
        }
        .code-block { 
            background-color: #1e293b; /* Gri 800 */
            color: #e2e8f0; /* Gri 200 */
            padding: 1rem; /* 16px */
            border-radius: 0.5rem; /* 8px */
            margin-top: 1rem; /* 16px */
            margin-bottom: 1rem; /* 16px */
            white-space: pre-wrap; 
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.875rem; /* 14px */
            line-height: 1.5; 
            overflow-x: auto; 
        }
        .explanation-summary {
            background-color: #ffe4e6; /* Rose 100 */
            padding: 0.75rem 1rem; /* 12px 16px */
            border-radius: 0.5rem; /* 8px */
            margin-bottom: 0.5rem; /* 8px */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #9f1239; /* Rose 800 */
            font-weight: 500; /* Orta */
            border: 1px solid #fecdd3; /* Rose 200 */
        }
        .explanation-summary:hover {
            background-color: #ffcdd2; /* Rose 200 (biraz daha koyu) */
        }
        .explanation-details { 
            margin-left: 1rem; /* 16px */
            padding-left: 1rem; /* 16px */
            border-left: 3px solid #fda4af; /* Rose 300 */
            padding-top: 0.5rem; /* 8px */
            padding-bottom: 0.5rem; /* 8px */
            color: #374151; /* Gri 700 */
        }
        .explanation-details p {
            margin-bottom: 0.75rem; /* 12px */
        }
        .explanation-details strong {
            color: #1f2937; /* Gri 800 */
        }
        details > summary { 
            list-style: none; 
        }
        details > summary::-webkit-details-marker { 
            display: none; 
        }
        details > summary::marker { 
            display: none; 
        }
        .chevron::before {
            border-style: solid;
            border-width: 0.15em 0.15em 0 0;
            content: '';
            display: inline-block;
            height: 0.45em;
            left: 0.15em;
            position: relative;
            top: 0.15em;
            transform: rotate(-45deg);
            vertical-align: top;
            width: 0.45em;
            transition: transform 0.2s ease-in-out;
        }
        details[open] > summary .chevron::before {
            transform: rotate(135deg);
        }
        .note {
            background-color: #fff1f2; /* Rose 50 */
            border-left: 4px solid #fb7185; /* Rose 400 */
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
            font-style: italic;
            color: #881337; /* Rose 800 */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-8">
        <header class="mb-8 pb-6 border-b border-gray-300">
            <h1 class="text-4xl font-bold text-center text-rose-700"><code>chat.js</code> AI Model Yönetimi Fonksiyon Raporu</h1>
            <p class="text-center text-gray-600 mt-3 text-lg"><code>chat.js</code> dosyasının "AI Model Yönetimi" (AI Model Management) olarak adlandırılan bölümündeki fonksiyonların ve komutlarının detaylı açıklaması.</p>
        </header>

        <section id="ai-management-overview" class="mb-10 p-6 bg-rose-50 rounded-lg border border-rose-200">
            <h2 class="text-2xl font-semibold text-rose-600 mb-3">6. AI Model Yönetimi (AI Model Management)</h2>
            <p class="text-gray-700 leading-relaxed">
                Bu bölüm, sohbet uygulamasında kullanılan yapay zeka modelleriyle ilgili temel işlemleri yönetir. 
                Kullanıcı mesajlarına göre (simüle edilmiş) yapay zeka yanıtlarının üretilmesi ve kullanıcıların 
                bir sohbet için farklı yapay zeka modelleri arasında geçiş yapabilmesi gibi işlevleri içerir.
            </p>
        </section>

        <section class="function-section" id="response-generation">
            <h3 class="text-xl function-title-text mb-3">6.1 Yanıt Üretimi (Response Generation)</h3>
            <p class="text-gray-600 mb-4">Bu alt bölüm, kullanıcı mesajına ve seçili yapay zeka modeline göre (simüle edilmiş) bir yanıt üreten fonksiyonu içerir.</p>
            
            <h4 class="text-lg font-semibold text-gray-700 mt-4">Fonksiyon: <code>getAIResponse(userMessage, aiModelId)</code></h4>
            <div class="code-block">
function getAIResponse(userMessage, aiModelId) {
    log('debug', \`getAIResponse called for userMessage: "\${userMessage}", aiModelId: "\${aiModelId}"\`);

    let modelIndex = 0; 
    if (window.state && window.state.aiTypes && Array.isArray(window.state.aiTypes)) {
        const foundIndex = window.state.aiTypes.findIndex(m => m.id === aiModelId);
        if (foundIndex !== -1) {
            modelIndex = foundIndex;
        } else {
            log('warn', \`getAIResponse: aiModelId "\${aiModelId}" not found... Defaulting to index 0.\`);
        }
    } else {
        log('warn', \`getAIResponse: window.state.aiTypes is not available... Defaulting to index 0.\`);
    }

    const responses = { 
        0: [ /* ... */ ],
        1: [ /* ... */ ],
        2: [ /* ... */ ]
        // IMPORTANT: Add more entries here if you have more than 3 AI models...
    };
    
    const aiModelSpecificResponses = responses[modelIndex] || responses[0]; 
    if (!aiModelSpecificResponses) { 
        log('error', \`getAIResponse: No responses found for modelIndex \${modelIndex} or default.\`);
        return "I'm currently unable to provide a specific response for this model.";
    }
    return aiModelSpecificResponses[Math.floor(Math.random() * aiModelSpecificResponses.length)];
}
            </div>
            <details class="mt-2">
                <summary class="explanation-summary">
                    <span>Komut Açıklamaları (Özetlenmiş)</span>
                    <span class="chevron"></span>
                </summary>
                <div class="explanation-details">
                    <p><strong><code>log('debug', ...);</code></strong>: Fonksiyonun çağrıldığını, hangi kullanıcı mesajı ve AI model ID'si ile çağrıldığını loglar.</p>
                    <p><strong><code>let modelIndex = 0;</code></strong>: Kullanılacak yanıt setini belirlemek için modelin indeksini saklayacak bir değişkeni varsayılan olarak 0 ile başlatır.</p>
                    <p><strong><code>if (window.state && window.state.aiTypes && Array.isArray(window.state.aiTypes)) { ... }</code></strong>: Global <code>window.state.aiTypes</code> dizisinin var olup olmadığını ve bir dizi olup olmadığını kontrol eder.</p>
                    <ul>
                        <li><strong><code>const foundIndex = window.state.aiTypes.findIndex(m => m.id === aiModelId);</code></strong>: Sağlanan <code>aiModelId</code>'ye sahip modelin <code>aiTypes</code> dizisindeki indeksini bulur.</li>
                        <li><strong><code>if (foundIndex !== -1) { modelIndex = foundIndex; }</code></strong>: Model bulunursa, <code>modelIndex</code>'i bulunan indeksle günceller.</li>
                        <li><strong><code>else { log('warn', ...); }</code></strong>: Model bulunamazsa, bir uyarı loglar ve <code>modelIndex</code> varsayılan olarak 0 kalır.</li>
                    </ul>
                    <p><strong><code>else { log('warn', ...); }</code></strong>: <code>window.state.aiTypes</code> mevcut değilse veya bir dizi değilse, bir uyarı loglar ve <code>modelIndex</code> varsayılan olarak 0 kalır.</p>
                    <p><strong><code>const responses = { ... };</code></strong>: Farklı model indekslerine (0, 1, 2) karşılık gelen önceden tanımlanmış simüle edilmiş yanıtların bir listesini içeren bir objedir. Her model indeksi için bir dizi yanıt metni bulunur.
                        <div class="note">
                            <strong>Not:</strong> Bu fonksiyon gerçek bir yapay zeka API'sine bağlanmaz. Bunun yerine, <code>sendMessage</code> fonksiyonu gerçek AI etkileşimini yönetirken, bu fonksiyon yalnızca geliştirme/test amacıyla veya basit, önceden tanımlanmış yanıtlar sağlamak için simüle edilmiş yanıtlar üretir.
                        </div>
                    </p>
                    <p><strong><code>const aiModelSpecificResponses = responses[modelIndex] || responses[0];</code></strong>: Hesaplanan <code>modelIndex</code>'e karşılık gelen yanıt listesini <code>responses</code> objesinden alır. Eğer o indeks için bir yanıt listesi yoksa, varsayılan olarak 0 indeksindeki yanıt listesini kullanır.</p>
                    <p><strong><code>if (!aiModelSpecificResponses) { ... }</code></strong>: Eğer <code>modelIndex</code> veya varsayılan (0) için hiçbir yanıt listesi bulunamazsa (bu, <code>responses</code> objesinin eksik yapılandırıldığı anlamına gelir), bir hata loglar ve genel bir hata mesajı döndürür.</p>
                    <p><strong><code>return aiModelSpecificResponses[Math.floor(Math.random() * aiModelSpecificResponses.length)];</code></strong>: Seçilen model için uygun yanıt listesinden rastgele bir yanıt seçer ve döndürür.</p>
                </div>
            </details>
        </section>

        <section class="function-section" id="model-selection">
            <h3 class="text-xl function-title-text mb-3">6.2 Model Seçimi (Model Selection)</h3>
            <p class="text-gray-600 mb-4">Bu alt bölüm, kullanıcıların bir sohbet için yapay zeka modelini seçmesini ve değiştirmesini sağlayan fonksiyonları içerir.</p>

            <h4 class="text-lg font-semibold text-gray-700 mt-4">Fonksiyon: <code>showModelDropdown(chatId, titleElement)</code></h4>
            <div class="code-block">
function showModelDropdown(chatId, titleElement) {
    log('action', 'Showing model dropdown', chatId);
    
    document.querySelectorAll('.model-dropdown').forEach(dropdown => {
        if (dropdown.parentNode) {
            dropdown.parentNode.removeChild(dropdown);
        }
    });
    
    const chat = state.chats.find(c => c.id === chatId);
    if (!chat) { /* ... */ return; }
    if (!window.state || !window.state.aiTypes || window.state.aiTypes.length === 0) {
        // ... (Hata ve uyarı yönetimi)
        return;
    }

    const dropdown = document.createElement('div');
    dropdown.className = 'model-dropdown';
    
    const options = window.state.aiTypes.map(model => {
        const isSelected = model.id === chat.aiModelId;
        return \`
            &lt;div class="model-option \${isSelected ? 'selected' : ''}" data-model-id="\${model.id}"&gt;
                &lt;i class="\${model.icon || 'bi bi-cpu'}"&gt;&lt;/i&gt;
                &lt;span&gt;\${model.name || 'Unknown Model'}&lt;/span&gt;
                \${isSelected ? '&lt;i class="bi bi-check-lg ms-auto"&gt;&lt;/i&gt;' : ''}
            &lt;/div&gt;
        \`;
    }).join('');
    
    dropdown.innerHTML = options;
    elements.chatContainer.appendChild(dropdown); // Ana sohbet konteynerine ekleniyor

    const titleRect = titleElement.getBoundingClientRect();
    const containerRect = elements.chatContainer.getBoundingClientRect();

    dropdown.style.position = 'absolute';
    dropdown.style.top = \`\${titleRect.bottom - containerRect.top + elements.chatContainer.scrollTop}px\`;
    dropdown.style.left = \`\${titleRect.left - containerRect.left + elements.chatContainer.scrollLeft}px\`;
    
    setTimeout(() => { dropdown.classList.add('show'); }, 10);
    
    dropdown.querySelectorAll('.model-option').forEach(option => {
        option.onclick = (e) => {
            e.stopPropagation();
            const newModelId = option.getAttribute('data-model-id');
            if (newModelId) {
                changeAIModel(chatId, newModelId);
            }
            // ... (Açılır menüyü kapatma)
        };
    });
    
    // ... (Açılır menü dışına tıklandığında kapatma mantığı)
}
            </div>
            <details class="mt-2">
                <summary class="explanation-summary">
                    <span>Komut Açıklamaları (Özetlenmiş)</span>
                    <span class="chevron"></span>
                </summary>
                <div class="explanation-details">
                    <p><strong><code>log('action', ...);</code></strong>: Model seçim açılır menüsünün gösterilme eylemini loglar.</p>
                    <p><strong><code>document.querySelectorAll('.model-dropdown').forEach(...);</code></strong>: Sayfada mevcut olabilecek diğer tüm model seçim açılır menülerini kaldırır. Bu, aynı anda sadece bir tane açık olmasını sağlar.</p>
                    <p><strong><code>const chat = state.chats.find(c => c.id === chatId);</code></strong>: İlgili sohbeti ID'si ile bulur.</p>
                    <p><strong><code>if (!window.state || !window.state.aiTypes || ...)</code></strong>: AI modelleri listesinin (<code>window.state.aiTypes</code>) mevcut olup olmadığını kontrol eder. Yoksa hata loglar, kullanıcıya uyarı gösterir ve çıkar.</p>
                    <p><strong><code>const dropdown = document.createElement('div'); dropdown.className = 'model-dropdown';</code></strong>: Açılır menü için yeni bir <code>&lt;div&gt;</code> elemanı oluşturur ve ona CSS sınıfı atar.</p>
                    <p><strong><code>const options = window.state.aiTypes.map(model => { ... }).join('');</code></strong>: <code>window.state.aiTypes</code> dizisindeki her bir AI modeli için bir HTML seçeneği oluşturur.
                        <ul>
                            <li><strong><code>const isSelected = model.id === chat.aiModelId;</code></strong>: Modelin o anki sohbette seçili olup olmadığını kontrol eder.</li>
                            <li>Döndürülen HTML, modelin ikonunu, adını ve eğer seçiliyse bir onay işaretini içerir. Her seçenek <code>data-model-id</code> niteliğiyle modelin ID'sini taşır.</li>
                        </ul>
                    </p>
                    <p><strong><code>dropdown.innerHTML = options; elements.chatContainer.appendChild(dropdown);</code></strong>: Oluşturulan seçenekleri açılır menüye ekler ve açılır menüyü ana sohbet kapsayıcısına (<code>elements.chatContainer</code>) ekler.</p>
                    <p><strong><code>const titleRect = titleElement.getBoundingClientRect(); ...</code></strong>: Açılır menüyü, tıklandığı başlık elemanının (<code>titleElement</code>) hemen altına konumlandırmak için gerekli pozisyon hesaplamalarını yapar.</p>
                    <p><strong><code>setTimeout(() => { dropdown.classList.add('show'); }, 10);</code></strong>: Küçük bir gecikmeyle (CSS geçişlerine izin vermek için) açılır menüye <code>show</code> sınıfını ekleyerek görünür hale getirir.</p>
                    <p><strong><code>dropdown.querySelectorAll('.model-option').forEach(option => { ... });</code></strong>: Açılır menüdeki her bir model seçeneğine tıklama olayı dinleyicisi atar.</p>
                    <ul>
                        <li><strong><code>e.stopPropagation();</code></strong>: Olayın yayılmasını engeller.</li>
                        <li><strong><code>const newModelId = option.getAttribute('data-model-id');</code></strong>: Tıklanan seçeneğin model ID'sini alır.</li>
                        <li><strong><code>if (newModelId) { changeAIModel(chatId, newModelId); }</code></strong>: Geçerli bir model ID'si varsa, <code>changeAIModel</code> fonksiyonunu çağırarak sohbetin modelini değiştirir.</li>
                        <li>Açılır menü kapatılır.</li>
                    </ul>
                    <p>Sayfanın herhangi bir yerine (açılır menü veya başlık elemanı dışına) tıklandığında açılır menüyü kapatmak için bir olay dinleyicisi (<code>document.addEventListener('click', closeDropdown, { once: true });</code>) eklenir.</p>
                </div>
            </details>

            <h4 class="text-lg font-semibold text-gray-700 mt-6">Fonksiyon: <code>changeAIModel(chatId, newAiModelId)</code></h4>
            <div class="code-block">
function changeAIModel(chatId, newAiModelId) {
    log('action', 'Changing AI model for chat:', chatId, 'to new ID:', newAiModelId);
    
    const chat = state.chats.find(c => c.id === chatId);
    if (!chat) { /* ... */ return; }
    
    if (chat.messages && chat.messages.some(msg => msg.isUser)) {
        log('warn', 'Cannot change model: chat already has messages', chatId);
        ModalManager.showAlert('Cannot change AI model: conversation has already started.');
        return;
    }
    
    if (!window.state || !window.state.aiTypes || window.state.aiTypes.length === 0) {
        // ... (Hata ve uyarı yönetimi)
        return;
    }

    const newModel = window.state.aiTypes.find(m => m.id === newAiModelId);
    if (!newModel) {
        log('error', 'Invalid new AI Model ID:', newAiModelId);
        ModalManager.showAlert('Invalid AI Model selected.');
        return;
    }
    
    chat.aiModelId = newAiModelId; 
    log('info', \`Chat \${chatId} AI model ID updated to: \${chat.aiModelId}\`);
    
    const chatElement = document.querySelector(\`.chat-window[data-chat-id="\${chatId}"]\`);
    if (chatElement) {
        const chatTitleElement = chatElement.querySelector('.chat-title');
        if (chatTitleElement) {
            // ... (Sohbet başlığındaki ikon ve ismi güncelleme)
        }
        
        const messagesContainer = chatElement.querySelector('.chat-messages');
        if (messagesContainer && (!chat.messages || chat.messages.length === 0)) {
            messagesContainer.innerHTML = createWelcomeMessageHTML(newModel.name || 'Selected AI');
        }
        log('debug', 'Chat element updated for new AI model', newModel);
    } else {
        log('warn', \`Chat element for \${chatId} not found... Re-rendering all.\`);
        renderChats(); 
    }
    renderActiveChatsDropdown();
}
            </div>
            <details class="mt-2">
                <summary class="explanation-summary">
                    <span>Komut Açıklamaları</span>
                    <span class="chevron"></span>
                </summary>
                <div class="explanation-details">
                    <p><strong><code>log('action', ...);</code></strong>: Bir sohbet için AI modelini değiştirme eylemini ve ilgili ID'leri loglar.</p>
                    <p><strong><code>const chat = state.chats.find(c => c.id === chatId);</code></strong>: İlgili sohbeti ID'si ile bulur.</p>
                    <p><strong><code>if (chat.messages && chat.messages.some(msg => msg.isUser)) { ... }</code></strong>: Eğer sohbette zaten kullanıcı tarafından gönderilmiş mesajlar varsa, modelin değiştirilemeyeceğini belirten bir uyarı loglar, kullanıcıya bilgi verir ve fonksiyondan çıkar. Model sadece konuşma başlamadan önce değiştirilebilir.</p>
                    <p><strong><code>if (!window.state || !window.state.aiTypes || ...)</code></strong>: AI modelleri listesinin mevcut olup olmadığını kontrol eder. Yoksa hata loglar, kullanıcıya uyarı gösterir ve çıkar.</p>
                    <p><strong><code>const newModel = window.state.aiTypes.find(m => m.id === newAiModelId);</code></strong>: Seçilen yeni model ID'sine karşılık gelen model bilgilerini <code>aiTypes</code> dizisinden bulur.</p>
                    <p><strong><code>if (!newModel) { ... }</code></strong>: Eğer seçilen yeni model ID'si geçersizse (<code>aiTypes</code> içinde bulunamazsa), hata loglar, kullanıcıya bilgi verir ve çıkar.</p>
                    <p><strong><code>chat.aiModelId = newAiModelId;</code></strong>: Sohbetin state'deki <code>aiModelId</code> özelliğini yeni seçilen modelin ID'si ile günceller.</p>
                    <p><strong><code>log('info', ...);</code></strong>: Model ID'sinin güncellendiğini loglar.</p>
                    <p><strong><code>const chatElement = document.querySelector(...);</code></strong>: İlgili sohbet penceresinin DOM elemanını bulur.</p>
                    <p><strong><code>if (chatElement) { ... }</code></strong>: Sohbet penceresi DOM'da bulunursa:</p>
                    <ul>
                        <li><strong><code>const chatTitleElement = chatElement.querySelector('.chat-title');</code></strong>: Sohbet başlığı elemanını bulur.</li>
                        <li><strong><code>if (chatTitleElement) { ... }</code></strong>: Başlık bulunursa, içindeki ikon ve model adını yeni seçilen modele göre günceller.</li>
                        <li><strong><code>const messagesContainer = chatElement.querySelector('.chat-messages');</code></strong>: Mesajların gösterildiği alanı bulur.</li>
                        <li><strong><code>if (messagesContainer && (!chat.messages || chat.messages.length === 0)) { ... }</code></strong>: Mesaj alanı varsa ve sohbette henüz hiç mesaj yoksa, yeni seçilen modelin adıyla bir karşılama mesajı (<code>createWelcomeMessageHTML</code>) oluşturur ve mesaj alanının içeriğini bununla günceller.</li>
                    </ul>
                    <p><strong><code>else { log('warn', ...); renderChats(); }</code></strong>: Eğer sohbet penceresi DOM'da bulunamazsa (beklenmedik bir durum), bir uyarı loglar ve tüm sohbet pencerelerini yeniden oluşturmak için <code>renderChats()</code> fonksiyonunu çağırır (bir fallback olarak).</p>
                    <p><strong><code>renderActiveChatsDropdown();</code></strong>: Kenar çubuğundaki aktif sohbetler açılır menüsünü güncelleyerek değişikliği yansıtır.</p>
                </div>
            </details>
        </section>

    </div>
</body>
</html>
